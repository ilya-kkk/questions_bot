import json

# Определение тем
TOPICS = {
    "Обработка и подготовка данных": [
        "пропущенные", "выбросы", "дублирующиеся", "нормализация", "стандартизация",
        "масштабировать", "очистка", "обрабатывать данные", "структурировать данные",
        "подготовка данных", "preprocessing", "one-hot", "label encoding", 
        "категориальные", "нечисловые признаки", "текстовые данные", "JSON",
        "агрегация данных", "мультиколлинеарность", "важность признаков",
        "отбора признаков", "feature engineering", "обработка категориальных",
        "обрабатывать пропущенные", "обрабатывать выбросы", "обрабатывать нечисловые"
    ],
    "Регрессия и классификация": [
        "регрессия", "классификация", "линейная регрессия", "логистическая регрессия",
        "KNN", "SVM", "опорных векторов", "многоклассовой", "дисбаланс классов",
        "несбалансированный", "классификатор", "классификации текста", "метод наименьших квадратов",
        "чем отличается регрессия от классификации", "выбрать алгоритм", "supervised", "unsupervised",
        "полином", "параболой", "таргет", "предикт", "предсказать"
    ],
    "Ансамбли и деревья": [
        "random forest", "случайный лес", "дерево решений", "градиентный бустинг",
        "XGBoost", "CatBoost", "bagging", "boosting", "ансамблирование", "деревья",
        "гиперпараметры деревьев", "глубина деревьев"
    ],
    "Глубокое обучение": [
        "нейронная сеть", "CNN", "сверточная", "RNN", "рекуррентные", "трансформер",
        "attention", "GAN", "Transfer Learning", "BatchNorm", "Dropout", "Residual",
        "свёртка", "pooling", "оптимайзер", "Adam", "PyTorch", "торч", "глубокое обучение"
    ],
    "Метрики и валидация": [
        "метрики", "precision", "recall", "ROC", "AUC", "кросс-валидация", "cross-validation",
        "bias-variance", "bias variance", "валидация", "train/test/validation", "качество модели",
        "оценить качество", "калибровки", "интерпретация метрик", "мало данных", "проверять валидацию",
        "выбрать порог", "порог отправки", "порог автоотклонения", "bias", "variance",
        "что уменьшается а что растет", "классического cv"
    ],
    "Регуляризация и переобучение": [
        "overfitting", "переобучение", "регуляризация", "L1", "L2", "Dropout",
        "регуляризации в DL", "регуляризация в линейных", "борьбы с переобучением"
    ],
    "Статистика и математика": [
        "статистика", "вероятность", "корреляция", "ковариация", "p-value", "доверительный интервал",
        "гипотеза", "статистический тест", "байесовская", "PCA", "SVD", "размерность",
        "матрица", "определитель", "линейная алгебра", "дисперсия", "выборочная дисперсия",
        "параметрические", "непараметрические", "нормальность", "bootstrap", "трансформация Фурье"
    ],
    "Оптимизация и обучение": [
        "градиентный спуск", "оптимизация", "гиперпараметры", "минимизация", "оптимизатор",
        "обучение модели", "дообучение", "обучаться на батче"
    ],
    "MLOps и продакшен": [
        "развертывание", "продакшен", "мониторинг", "версионирование моделей", "CI/CD",
        "Docker", "тестирование модели", "производительность модели", "проверяете работоспособность",
        "устойчивость к изменениям", "дебажить"
    ],
    "Инфраструктура и инструменты": [
        "Apache Airflow", "ETL", "хранилище данных", "большие данные", "распределенная среда",
        "pandas", "numpy", "визуализация", "Plotly", "Bokeh", "Dash", "мультитрединг",
        "мультипроцессинг", "асинхронность", "coroutine", "event loop", "микросервисы",
        "SQL", "NoSQL", "базы данных", "cloud", "batch processing", "stream processing",
        "версии данных", "pipeline", "инструменты для работы", "библиотеки"
    ],
    "Специальные задачи": [
        "временные ряды", "кластеризация", "K-means", "DBSCAN", "иерархическая кластеризация",
        "A/B тестирование", "бизнес-ценность", "приоритизация задач", "рисков",
        "взаимодействие с командами", "метрики счастья", "рекомендации", "компьютерное зрение",
        "3д", "облако точек", "треугольник", "круг", "картинки", "изображения",
        "тренда или сезонности", "сезонность", "тренд", "прогнозирование",
        "спроектировать сервис", "рекомендации мест", "метрики счастья"
    ]
}

def classify_question(question_text):
    """Классифицирует вопрос по теме на основе ключевых слов"""
    question_lower = question_text.lower()
    
    # Специальные правила для конкретных вопросов
    special_rules = {
        "бизнес-ценность": "Специальные задачи",
        "приоритизируете задачи": "Специальные задачи",
        "взаимодействуете с другими командами": "Специальные задачи",
        "подготовка данных": "Обработка и подготовка данных",
        "этапы подготовки": "Обработка и подготовка данных",
        "основные этапы подготовки": "Обработка и подготовка данных",
        "нейронные сети вместо": "Глубокое обучение",
        "использовать нейронные сети": "Глубокое обучение",
        "регуляризации": "Регуляризация и переобучение",
        "про регуляризации": "Регуляризация и переобучение",
        "распределенной среде": "Инфраструктура и инструменты",
        "распределенная среда": "Инфраструктура и инструменты",
        "работа с данными в распределенной": "Инфраструктура и инструменты",
        "минимизации с ограничениями": "Оптимизация и обучение",
        "решать задачу минимизации": "Оптимизация и обучение",
        "градиентный спуск": "Оптимизация и обучение",
        "минимизации с ограничениями": "Оптимизация и обучение",
        "выбрали гиперпараметры": "Оптимизация и обучение",
        "утечкой данных": "Обработка и подготовка данных",
        "data leakage": "Обработка и подготовка данных",
        "обрабатывать новую информацию": "Оптимизация и обучение",
        "дообучения модели": "Оптимизация и обучение",
        "важность признаков": "Обработка и подготовка данных",
        "отбора признаков": "Обработка и подготовка данных",
        "высокой размерностью": "Статистика и математика",
        "размерность данных": "Статистика и математика",
        "уменьшить размерность": "Статистика и математика",
        "тренда или сезонности": "Специальные задачи",
        "временные ряды": "Специальные задачи",
        "кластеризация": "Специальные задачи",
        "k-средних": "Специальные задачи",
        "dbscan": "Специальные задачи",
        "выбросы": "Обработка и подготовка данных",
        "аномалия": "Обработка и подготовка данных",
        "выборочная дисперсия": "Статистика и математика",
        "выбрать правильный алгоритм": "Регрессия и классификация",
        "supervised и unsupervised": "Регрессия и классификация",
        "выбрать порог": "Метрики и валидация",
        "порог отправки": "Метрики и валидация",
        "метрики счастья": "Специальные задачи",
        "рекомендации": "Специальные задачи",
        "компьютерное зрение": "Специальные задачи",
        "3д": "Специальные задачи",
        "облако точек": "Специальные задачи",
        "треугольник": "Специальные задачи",
        "картинок": "Специальные задачи",
        "изображений": "Специальные задачи",
        "классификатор картинок": "Глубокое обучение",
        "классифаера картинок": "Глубокое обучение",
        "выкачивал датасет картинок": "Инфраструктура и инструменты",
        "распараллелить": "Инфраструктура и инструменты",
        "батч 2048": "Оптимизация и обучение",
        "мини-батчей": "Оптимизация и обучение",
        "обработка на основе мини-батчей": "Оптимизация и обучение",
        "полином": "Регрессия и классификация",
        "параболой": "Регрессия и классификация",
        "аналитическим методом": "Оптимизация и обучение",
        "мало данных": "Метрики и валидация",
        "ограниченным доступом к данным": "Обработка и подготовка данных",
        "метаданными": "Инфраструктура и инструменты",
        "версии данных": "Инфраструктура и инструменты",
        "интерпретации сложных моделей": "Метрики и валидация",
        "калибровки": "Метрики и валидация",
        "калибровка": "Метрики и валидация",
        "евклидова и косинусная": "Статистика и математика",
        "меры расстояния": "Статистика и математика",
        "разворота списка": "Инфраструктура и инструменты",
        "полином с большими степенями": "Регуляризация и переобучение",
        "может выдать на тесте предикт": "Регрессия и классификация",
        "таргет имел значения": "Регрессия и классификация",
        "значения таргета больше 0": "Регрессия и классификация",
        "может предсказать отрицательное": "Регрессия и классификация",
        "глубина деревьев": "Ансамбли и деревья",
        "что будет если сделать bagging": "Ансамбли и деревья",
        "bias, variance": "Метрики и валидация",
        "что уменьшается а что растет": "Метрики и валидация",
        "больше склонно к переобучению": "Регуляризация и переобучение",
        "склонно к переобучению": "Регуляризация и переобучение",
        "град бустинг или случайный лес": "Ансамбли и деревья",
        "где градиент в град бустинге": "Ансамбли и деревья",
        "целевая переменная у n дерева": "Ансамбли и деревья",
        "подмножество фичей выбираем": "Ансамбли и деревья",
        "вершинах дерева": "Ансамбли и деревья",
        "реализации град бустингов": "Ансамбли и деревья",
        "особенности и отличия": "Ансамбли и деревья",
        "почему в проде используют": "MLOps и продакшен",
        "в проде используют": "MLOps и продакшен",
        "микросервисов": "Инфраструктура и инструменты",
        "монолита и микросервисов": "Инфраструктура и инструменты",
        "взаимодействия микросервисов": "Инфраструктура и инструменты",
        "спроектировать сервис": "Специальные задачи",
        "рекомендации мест": "Специальные задачи",
        "классического cv": "Метрики и валидация",
        "методы классического cv": "Метрики и валидация",
        "разметку и построение модели": "Регрессия и классификация",
        "разметку и построение": "Регрессия и классификация",
        "классификации запросов": "Регрессия и классификация",
        "описать как будем размечать": "Регрессия и классификация",
    }
    
    # Проверяем специальные правила
    for key, topic in special_rules.items():
        if key in question_lower:
            return topic
    
    # Подсчет совпадений для каждой темы
    scores = {}
    for topic, keywords in TOPICS.items():
        score = sum(1 for keyword in keywords if keyword.lower() in question_lower)
        if score > 0:
            scores[topic] = score
    
    if not scores:
        # Если не найдено совпадений, пробуем более общие правила
        if any(word in question_lower for word in ["python", "питон", "dict", "список", "args", "kwargs", "разворота"]):
            return "Инфраструктура и инструменты"
        elif any(word in question_lower for word in ["модель", "алгоритм", "обучить"]):
            return "Регрессия и классификация"
        elif any(word in question_lower for word in ["данные", "датасет"]):
            return "Обработка и подготовка данных"
        else:
            return "Специальные задачи"
    
    # Возвращаем тему с наибольшим количеством совпадений
    return max(scores.items(), key=lambda x: x[1])[0]

def update_topics_in_json():
    """Читает JSON, классифицирует вопросы и обновляет поле topic"""
    with open('raw.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    for item in data:
        if not item.get('topic') or item['topic'] == '':
            topic = classify_question(item['question'])
            item['topic'] = topic
            print(f"ID {item['id']}: {topic}")
    
    with open('raw.json', 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    
    print(f"\nОбновлено {len(data)} вопросов")

if __name__ == "__main__":
    update_topics_in_json()

